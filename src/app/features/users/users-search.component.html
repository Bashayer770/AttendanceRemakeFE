<div class="flex flex-col items-center justify-start bg-gray-50 arabic-text">
  <div class="w-full max-w-7xl bg-white shadow-lg px-8 pb-4 rounded-lg">
    <div
      class="bg-primary text-white text-center py-4 rounded-t-lg -mx-8 -mt-2 mb-8"
    >
      <h2 class="text-3xl font-sans arabic-text">بحث الموظف</h2>
    </div>

    <form
      [formGroup]="form"
      (ngSubmit)="onSearch()"
      class="flex gap-2 mb-6"
      dir="rtl"
    >
      <input
        type="text"
        formControlName="query"
        placeholder="أدخل رقم الموظف، رقم البصمة، اسم الدخول، أو الاسم"
        class="w-full px-4 py-3 border-b-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:bg-white hover:bg-slate-100 arabic-text"
      />
      <select
        formControlName="type"
        class="px-3 py-3 border-b-2 border-gray-300 rounded-lg bg-white"
      >
        <option value="auto">تلقائي</option>
        <option value="empNo">رقم الموظف</option>
        <option value="fingerCode">رقم البصمة</option>
        <option value="loginName">اسم الدخول</option>
        <option value="name">الاسم</option>
      </select>
      <button
        type="submit"
        class="bg-primary text-white px-6 rounded-lg hover:bg-primary/80"
      >
        بحث
      </button>
    </form>

    <div *ngIf="loading" class="text-center text-gray-500">...جاري البحث</div>
    <div *ngIf="error" class="text-center text-red-600">{{ error }}</div>

    <!-- Two-column layout: left = details, right = fetched user card -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-start" dir="ltr">
      <!-- Static details panel (left) -->
      <div class="lg:col-start-1 lg:col-span-1">
        <div
          *ngIf="showDetails"
          class="bg-white border rounded-xl shadow p-5 min-h-[260px]"
          dir="rtl"
        >
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-xl font-semibold m-0">تفاصيل الموظف</h3>
            <button
              type="button"
              class="px-3 py-2 rounded shadow hover:shadow-md text-primary"
              (click)="openEdit()"
            >
              <app-edit-square></app-edit-square>
            </button>
          </div>
          <ng-container *ngIf="vm as d; else noDetails">
            <div class="space-y-2 text-gray-800">
              <div class="flex items-center gap-2">
                <span
                  class="inline-block w-2.5 h-2.5 rounded-full"
                  [ngClass]="{
                    'bg-green-500': d.status === 1,
                    'bg-red-500': d.status === 0
                  }"
                ></span>
                <span class="font-semibold">الاسم:</span> {{ d.name || "-" }}
              </div>
              <div>
                <span class="font-semibold">الرقم الوظيفي:</span>
                {{ d.empNo || "-" }}
              </div>
              <div>
                <span class="font-semibold">اسم الدخول:</span>
                {{ d.loginName || "-" }}
              </div>
              <div>
                <span class="font-semibold">الوظيفة:</span> {{ d.role || "-" }}
              </div>
              <div>
                <span class="font-semibold">القسم:</span>
                {{ d.deptName || "-" }}
              </div>
              <div>
                <span class="font-semibold">القطاع:</span>
                {{ d.sectorName || "-" }}
              </div>
              <hr class="my-2" />
              <div class="text-sm text-gray-600">
                <span class="font-semibold">البصمه:</span>
                {{ d.fingerCode ?? "-" }}
              </div>
              <div class="text-sm text-gray-600">
                <span class="font-semibold">فتره الدوام:</span>
                {{ d.timingPlanName || "-" }}
              </div>
              <div class="text-sm text-gray-600">
                <span class="font-semibold">تخفيف:</span>
                {{
                  d.hasAllow === true
                    ? "نعم"
                    : d.hasAllow === false
                    ? "لا"
                    : "-"
                }}
              </div>
              <div class="text-sm text-gray-600">
                <span class="font-semibold">الحاله:</span>
                {{
                  d.status === 1 ? "فعال" : d.status === 0 ? "غير فعال" : "-"
                }}
              </div>
            </div>
            <div class="mt-4 flex justify-center gap-3">
              <button
                type="button"
                class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/80 arabic-text"
                (click)="openAttendance()"
              >
                كشف الحضور
              </button>
            </div>
            <app-attendance-modal
              [isVisible]="isAttendanceVisible"
              [empNo]="d.empNo || null"
              [empName]="d.name || null"
              [loginName]="d.loginName || null"
              (close)="closeAttendance()"
            ></app-attendance-modal>
            <app-edit-user-modal
              [isVisible]="isEditVisible"
              [empNo]="d.empNo || null"
              [fingerCode]="d.fingerCode ?? null"
              [timingCode]="d.timingCode ?? null"
              [hasAllow]="d.hasAllow ?? null"
              [status]="d.status ?? null"
              (save)="onSaveEdit($event)"
              (close)="closeEdit()"
            ></app-edit-user-modal>
          </ng-container>
          <ng-template #noDetails>
            <div class="text-gray-400">لا توجد تفاصيل للعرض</div>
          </ng-template>
        </div>
      </div>

      <!-- Fetched user card (right) -->
      <div class="lg:col-start-2 lg:col-span-2" dir="rtl">
        <!-- Name search results list -->
        <div
          *ngIf="results && results.length > 0"
          class="bg-white rounded-lg shadow divide-y"
        >
          <div
            class="p-3 cursor-pointer flex items-center justify-between"
            [ngClass]="{
              'bg-primary/10 hover:bg-primary/20': selectedEmpNo === r.empNo,
              'hover:bg-slate-50': selectedEmpNo !== r.empNo
            }"
            *ngFor="let r of results"
            (click)="selectResult(r)"
          >
            <div class="flex items-center gap-2">
              <span
                class="inline-block w-2.5 h-2.5 rounded-full"
                [ngClass]="{
                  'bg-green-500': r.status === 1,
                  'bg-red-500': r.status === 0
                }"
              ></span>
              <div class="font-semibold">
                {{ r.fullName || r.nameA || r.nameE }}
              </div>
            </div>
            <div class="text-sm text-gray-500">رقم وظيفي: {{ r.empNo }}</div>
          </div>
        </div>

        <!-- Single fetched user card -->
        <div
          *ngIf="!results?.length && vm as r"
          class="border rounded-lg shadow-sm p-4 bg-white cursor-pointer"
          dir="rtl"
          (click)="openDetails()"
        >
          <div class="flex items-center justify-between">
            <div class="text-lg font-semibold">{{ r.name || "-" }}</div>
            <div class="text-sm text-gray-500">
              رقم وظيفي: {{ r.empNo || "-" }}
            </div>
          </div>
          <div class="mt-2 text-gray-700">الوظيفة: {{ r.role || "-" }}</div>
          <div class="mt-1 text-gray-700">القسم: {{ r.deptName || "-" }}</div>
          <div class="mt-1 text-gray-700">
            القطاع: {{ r.sectorName || "-" }}
          </div>
        </div>
        <div
          *ngIf="!vm && !results?.length && !loading && !error"
          class="text-center text-gray-400 py-8"
          dir="rtl"
        >
          {{ hasSearched ? "لا توجد بيانات" : "ادخل بيانات الموظف" }}
        </div>
      </div>
    </div>
  </div>
</div>
